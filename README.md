# QCXIS Game Server (Rust WebSocket)

A high-performance WebSocket server built with Rust to handle real-time multiplayer typing game sessions.

## ğŸ¯ Purpose

This Rust-based game server was created to handle multiplayer game connections separately from Laravel Reverb to avoid payload size limitations and provide better performance for real-time game state updates.

## ğŸš€ Features

- **High Performance**: Built with Tokio for async I/O and efficient WebSocket handling
- **Real-time Game State**: Broadcast player progress, typing speed (WPM), and accuracy in real-time
- **JWT Authentication**: Secure authentication using JWT tokens generated by Laravel
- **Room Management**: Automatic game room creation and player management
- **Scalable**: Can handle multiple concurrent games with many players

## ğŸ“‹ Requirements

- Rust 1.70+ (install from https://rustup.rs/)
- PostgreSQL (for Laravel backend)
- Laravel application running

## ğŸ› ï¸ Setup

### 1. Install Rust

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source $HOME/.cargo/env
```

### 2. Configure Environment

```bash
cd game-server
cp .env.example .env
```

Edit `.env` and set:

```env
GAME_SERVER_HOST=0.0.0.0
GAME_SERVER_PORT=8080
HTTP_SERVER_PORT=8081
LARAVEL_API_URL=http://localhost:8000
JWT_SECRET=your-jwt-secret-here  # Must match Laravel's APP_KEY
GAME_TIMEOUT_SECONDS=300
```

**Important**: The `JWT_SECRET` must match your Laravel application's `APP_KEY` or `JWT_SECRET` setting.

### 3. Build and Run

**Development mode:**
```bash
cargo run
```

**Production mode:**
```bash
cargo build --release
./target/release/qcxis-game-server
```

The server will start on:
- WebSocket: `ws://0.0.0.0:8080`
- HTTP Status: `http://0.0.0.0:8081`

## ğŸ“Š Monitoring & Status Endpoints

The game server provides HTTP endpoints for monitoring and metrics:

### Status Endpoint
`GET http://localhost:8081/status`

Returns detailed server metrics in JSON format:

```json
{
  "status": "online",
  "uptime_seconds": 3600,
  "timestamp": 1705123456,
  "system": {
    "cpu_usage_percent": 12.5,
    "memory_used_mb": 512,
    "memory_total_mb": 8192,
    "memory_used_percent": 6.25,
    "process_memory_mb": 45
  },
  "games": {
    "total_games": 5,
    "active_connections": 25,
    "total_players_connected": 25
  }
}
```

### Health Check
`GET http://localhost:8081/health`

Simple health check endpoint:

```json
{
  "status": "healthy",
  "service": "qcxis-game-server"
}
```

### Prometheus Metrics
`GET http://localhost:8081/metrics`

Returns metrics in Prometheus format for monitoring tools like Grafana:

```
# HELP qcxis_cpu_usage_percent CPU usage percentage
# TYPE qcxis_cpu_usage_percent gauge
qcxis_cpu_usage_percent 12.5
# HELP qcxis_memory_used_mb Memory used in MB
# TYPE qcxis_memory_used_mb gauge
qcxis_memory_used_mb 512
...
```

### Monitoring Integration

**With Prometheus:**
Add to `prometheus.yml`:
```yaml
scrape_configs:
  - job_name: 'qcxis-game-server'
    static_configs:
      - targets: ['localhost:8081']
```

**With Grafana:**
1. Add Prometheus as data source
2. Import metrics from the `/metrics` endpoint
3. Create dashboards with queries like:
   - `qcxis_cpu_usage_percent`
   - `qcxis_memory_used_mb`
   - `qcxis_active_connections`
   - `qcxis_total_games`

**Using the Status Dashboard:**
1. Open `status-dashboard.html` in your browser
2. Update the `API_URL` if using a different host/port
3. Real-time metrics will auto-refresh every 2 seconds
4. Features:
   - Live CPU and Memory usage charts
   - Active games, connections, and player counts
   - Server uptime and resource utilization
   - Historical data visualization (last 60 seconds)

## ğŸ”§ Laravel Integration

### 1. Install JWT Library

In your Laravel project root:

```bash
composer require firebase/php-jwt
```

### 2. Update .env

Add to your Laravel `.env`:

```env
GAME_SERVER_HOST=0.0.0.0
GAME_SERVER_PORT=8080
GAME_SERVER_WS_URL=ws://127.0.0.1:8080
VITE_GAME_SERVER_URL=ws://127.0.0.1:8080
```

For production, use your domain:
```env
GAME_SERVER_WS_URL=wss://game.yourdomain.com
VITE_GAME_SERVER_URL=wss://game.yourdomain.com
```

### 3. Configuration Files

The following files have been created:
- `config/game-server.php` - Laravel configuration
- `app/Services/GameServerService.php` - Token generation service

### 4. Frontend Integration

The game WebSocket composable is available at:
- `resources/js/composables/useGameWebSocket.ts`

## ğŸ“¡ WebSocket Protocol

### Client â†’ Server Messages

#### Authentication
```json
{
  "type": "auth",
  "token": "JWT_TOKEN_HERE",
  "game_id": "game-uuid"
}
```

#### Start Game (Host only)
```json
{
  "type": "start_game"
}
```

#### Update Progress (During gameplay)
```json
{
  "type": "update_progress",
  "progress": 45,
  "wpm": 67,
  "accuracy": 96.5
}
```

#### Finish Game
```json
{
  "type": "finish_game",
  "wpm": 72,
  "accuracy": 98.2,
  "time_taken": 120
}
```

#### Heartbeat
```json
{
  "type": "ping"
}
```

### Server â†’ Client Messages

#### Connected
```json
{
  "type": "connected",
  "player_id": "player-uuid"
}
```

#### Game State
```json
{
  "type": "game_state",
  "game": {
    "id": "game-uuid",
    "code": "ABC123",
    "difficulty": "medium",
    "text": "typing text here...",
    "host_id": "user-id",
    "players": [...],
    "status": "waiting",
    "max_players": 10
  }
}
```

#### Player Joined
```json
{
  "type": "player_joined",
  "player": {
    "id": "player-uuid",
    "user_id": "user-id",
    "username": "JohnDoe",
    "wpm": 0,
    "accuracy": 0,
    "progress": 0,
    "finished": false
  }
}
```

#### Game Started
```json
{
  "type": "game_started",
  "started_at": 1703001234
}
```

#### Player Progress
```json
{
  "type": "player_progress",
  "player_id": "player-uuid",
  "progress": 45,
  "wpm": 67,
  "accuracy": 96.5
}
```

#### Player Finished
```json
{
  "type": "player_finished",
  "player_id": "player-uuid",
  "wpm": 72,
  "accuracy": 98.2,
  "finished_at": 1703001350
}
```

#### Game Finished
```json
{
  "type": "game_finished",
  "winner_id": "player-uuid",
  "final_standings": [...]
}
```

#### Error
```json
{
  "type": "error",
  "message": "Error description"
}
```

## ğŸ”’ Security

- **JWT Authentication**: All connections must authenticate with a valid JWT token
- **Token Expiry**: Tokens expire after 1 hour by default
- **Host-only Actions**: Only the game host can start games

## ğŸ³ Docker Deployment

Create `game-server/Dockerfile`:

```dockerfile
FROM rust:1.75 as builder
WORKDIR /app
COPY . .
RUN cargo build --release

FROM debian:bookworm-slim
RUN apt-get update && apt-get install -y libssl3 ca-certificates && rm -rf /var/lib/apt/lists/*
COPY --from=builder /app/target/release/qcxis-game-server /usr/local/bin/
CMD ["qcxis-game-server"]
```

Build and run:
```bash
docker build -t qcxis-game-server .
docker run -p 8080:8080 --env-file .env qcxis-game-server
```

## ğŸš€ Production Deployment

### Using systemd

Create `/etc/systemd/system/qcxis-game-server.service`:

```ini
[Unit]
Description=QCXIS Game Server
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/var/www/qcxis/game-server
Environment="RUST_LOG=info"
EnvironmentFile=/var/www/qcxis/game-server/.env
ExecStart=/var/www/qcxis/game-server/target/release/qcxis-game-server
Restart=always

[Install]
WantedBy=multi-user.target
```

Enable and start:
```bash
sudo systemctl enable qcxis-game-server
sudo systemctl start qcxis-game-server
sudo systemctl status qcxis-game-server
```

### Nginx Configuration

Add to your Nginx config:

```nginx
# Game Server WebSocket Proxy
location /game-ws {
    proxy_pass http://127.0.0.1:8080;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
}
```

## ğŸ“Š Monitoring

View logs:
```bash
# Development
cargo run

# Production (systemd)
sudo journalctl -u qcxis-game-server -f

# Production (Docker)
docker logs -f <container-id>
```

## ğŸ§ª Testing

Test WebSocket connection:
```bash
# Using websocat
websocat ws://127.0.0.1:8080

# Send auth message
{"type":"auth","token":"YOUR_JWT_TOKEN","game_id":"game-uuid"}
```

## ğŸ¤ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      HTTP/Inertia     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Laravel   â”‚
â”‚  (Vue.js)   â”‚                        â”‚  (API/Web)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                       â”‚
       â”‚                                       â”‚ Generates
       â”‚                                       â”‚ JWT Token
       â”‚                                       â–¼
       â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚        WebSocket             â”‚ GameServerServiceâ”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  (Token Auth)   â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚  Rust Game WS   â”‚
                                      â”‚     Server      â”‚
                                      â”‚ (Real-time Game)â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Laravel Reverb** is still used for:
- Notifications
- Chat messages
- General broadcasting
- Non-game real-time features

**Rust Game Server** is used for:
- Multiplayer game sessions
- Real-time typing progress
- Game state synchronization
- High-frequency updates

## ğŸ“ Notes

- The game server runs independently from Laravel
- Laravel generates JWT tokens for authentication
- Game results are still stored in Laravel database
- Reverb handles all other real-time features (notifications, chat, etc.)

## ğŸ› Troubleshooting

**Connection refused:**
- Check if server is running: `ps aux | grep qcxis-game-server`
- Check port availability: `netstat -tulpn | grep 8080`

**Authentication failed:**
- Verify JWT_SECRET matches between Laravel and Rust
- Check token expiration
- Ensure user is authenticated in Laravel

**High CPU usage:**
- Check number of concurrent connections
- Review logs for errors
- Consider scaling horizontally

## ğŸ“š Dependencies

- **tokio**: Async runtime
- **tokio-tungstenite**: WebSocket implementation
- **serde**: JSON serialization
- **dashmap**: Concurrent HashMap
- **jsonwebtoken**: JWT verification
- **tracing**: Logging

## ğŸ® Usage in Vue Components

```vue
<script setup>
import { useGameWebSocket } from '@/composables/useGameWebSocket';

const props = defineProps<{
    game: Game;
    gameToken: string;
    gameServerUrl: string;
}>();

const {
    connected,
    gameState,
    error,
    startGame,
    updateProgress,
    finishGame,
} = useGameWebSocket(props.game.id, props.gameToken, props.gameServerUrl);

// Use the methods as needed
const handleStartGame = () => {
    startGame();
};

const handleTyping = (progress: number, wpm: number, accuracy: number) => {
    updateProgress(progress, wpm, accuracy);
};
</script>
```

## ğŸ“„ License

This game server is part of the QCXIS project.
